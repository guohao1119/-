## 作用域是什么

  一套设计良好的规则，用于存储变量，并且之后可以方便的找到这些变量
  
  即能够存储和查找变量的一套规则

### 编译原理

  程序中的一段源代码在执行之前会经历三个步骤，统称为‘编译’

#### 分词/词法分析

  将由字符组成的字符串(程序)分解成有意义的代码块，这些代码块被称为词法单元(token)

  例如： var a = 2;
  会被分解成： var、a、=、2、；
  空格是否会被当作词法单元，取决于空格在这门语言中是否具有意义

#### 解析/语法分析

  将词法单元流(数组)转换成一个由元素逐级嵌套所组成的代表了程序语法结构的树，即抽象语法树(Abstract Syntax Tree, AST)

#### 代码生成

  将AST转换为可执行代码

  将var a = 2;的AST转换为一组机器指令，用来创建一个叫做a的变量，并将一个值储存在a中

### 理解作用域

#### 演员表

  ##### 引擎
    负责整个JavaScript程序的编译及执行过程

  ##### 编译器
    负责语法分析及代码生成等

  ##### 作用域
    负责收集并维护由所有声明的标识符(变量)组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限

#### 对话
  变量的赋值操作会执行两个动作
  
  1 编译器在当前作用域中声明一个变量(如果之前没有声明过)
  2 引擎在作用域(链)中查找该变量，如果能找到就对它赋值，没找到就抛出一个异常

#### LHS RHS
  赋值操作的目标是谁（LHS）
  谁是赋值操作的源头（RHS）

  例如：

    console.log(a)
    需要查找console.log，
    需要查找并取得a的值，才能传递给console.log，因此是RHS

    a = 2;
    需要找到a，以便进行赋值操作，即需要找到=2的目标

    function foo(a) {
      console.log(a);
    }

    foo(2);

    执行foo(2)时，需要查找foo，对foo进行RHS
    2是实参，a是形参，需要将2赋值给a，对a进行LHS
    执行console.log(a)，需要需要查找console.log、a，进行RHS

    function foo(a) {
      var b = a;
      return a + b;
    }

    var c = foo(2);

    foo(2) 查找foo，第1次RHS
    c = foo(2) 将foo(2)的返回值赋值给c，第一次LHS
    foo(2) 调用foo，将2赋值给a，第2次LHS
    var b = a; 查找a，第2次RHS，将a赋值给b，第3次LHS
    return a + b; 查找a和b，第3、4次RHS

#### 作用域嵌套
  当一个块或函数嵌套在另一个块或函数中时，就发生了作用域的嵌套。在当前作用域无法找到变量时，会在外层嵌套的作用域中继续查找，直到找到或者到最外层作用域(全局作用域)仍然未找到

  例如
  
    function foo(a) {
      console.log(a + b);
    }

    var b = 2;

    foo(2);

    在foo函数中无法找到b，到外层(全局)作用域中找，找到b

#### 异常
  在任何作用域都无法找到变量时，LHS和RHS的行为是不一样的

  RHS 引擎抛出ReferenceError
  LHS 会在全局作用域创建一个具有该名称的变量，并将其返回给引擎（非严格模式下）
  
  严格模式会禁止自动或隐式地创建全局变量，这种情况下会抛出ReferenceError

  进入严格模式
    
    'use strict'

    function foo(a) {
      b = a; // Uncaught ReferenceError: b is not defined
    }
    foo(2)

  RHS查询到一个变量，但是对变量值进行不合理的操作
  
  例如

    对一个非函数类型的值进行函数调用
      var a = 1;
      a();
    引用null或undefined类型的值中的属性
      var a = null;
      console.log(a.b)

  ReferenceError  同作用域判断失败相关
  TypeError       作用域判断成功，但是对结果的操作是非法或不合理的

### 小结

  作用域用于确定在何处以及如何查找变量

  如果查找的目的是对变量进行赋值，那么使用LHS查询

  如果目的是获取变量的值，那么使用RHS查询

  JavaScript引擎会在代码执行前进行编译，编译过程中对于var a = 2这样的声明会被分成两个步骤

  1 var a 在其作用域中声明新变量（此时代码未执行）
  2 a = 2会查询a（LSH查询），然后对其进行赋值

  LHS和RHS都会在当前执行作用域中开始，并逐级向上查找，直到找到或者抵达最外层作用域

  失败的RHS会抛出ReferenceError
  失败的LHS会自动创建一个全局变量(非严格模式下)
  失败的LHS会抛出ReferenceError(严格模式下)



